# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: snyk-sast
on:
  workflow_call: {}
  workflow_dispatch: {}
jobs:
  sast-scan:
    name: Run SAST Scan with Snyk
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    steps:
      - name: Setup node 20
        id: setup-node20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Get npm global installation root folder
        id: get-npm-root
        run: |-
          NPM_ROOT_LIBS=$(npm root -g)
          NPM_ROOT=$(echo $NPM_ROOT_LIBS | sed 's//lib/node_modules//')
          echo "npm-root-global-libs=$NPM_ROOT_LIBS"
          echo "path=$NPM_ROOT"
          echo path=$NPM_ROOT >> $GITHUB_OUTPUT
      - name: Cache global npm folder
        id: cache-npmg
        uses: actions/cache@v4
        with:
          path: ${{ steps.get-npm-root.outputs.path }}
          key: ${{ runner.os }}-npm-global-snyk-${{ hashFiles(".projenrc.ts") }}
      - name: Install snyk and snyk-delta
        id: install-snyk
        if: steps.cache-npmg.outputs.cache-hit != 'true'
        run: npm i -g snyk@[object Object] snyk-delta@[object Object]
      - name: Create cache for snyk-pr-diff
        id: cache-snyk-pr-diff
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/snyk-pr-diff
          key: ${{ runner.os }}-snyk-pr-diff-${{ hashFiles(".projenrc.ts") }}
      - name: Install snyk-pr-diff
        id: install-snyk-pr-diff
        if: steps.cache-snyk-pr-diff.outputs.cache-hit != 'true'
        run: |-
          wget -O snyk-pr-diff https://github.com/snyk-playground/cx-tools/raw/ed3737a48ab2f82fc6aa7b8878e052e4efb7754c/snyk-pr-diff/bin/snyk-pr-diff-amd64-linux
          chmod +x ./snyk-pr-diff
          mv ./snyk-pr-diff /usr/local/bin/snyk-pr-diff
          which snyk-pr-diff
      - name: Checkout current branch
        id: checkout-current
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.after }}
      - name: Authenticate Snyk
        id: snyk-auth
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |-
          snyk auth $SNYK_TOKEN
          snyk config set org=vianho
      - name: Run snyk code on current branch
        id: snyk-sast-current
        run: |-
          SHA=$(git log -1 '--format=format:%H')
          RESULT_PATH="${{ github.workspace }}/snyk_code_result_$SHA.json"
          snyk code test --severity-threshold=high --json > $RESULT_PATH
          echo "result-path=$RESULT_PATH" >> $GITHUB_OUTPUT
        continue-on-error: false
