# ~~ Generated by projen. To modify, edit .projenrc.ts and run "npx projen".

name: snyk-sca
on:
  workflow_call: {}
  workflow_dispatch: {}
jobs:
  sca-scan:
    name: sca-scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup node 20
        id: setup-node20
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Get npm global installation root folder
        id: get-npm-root
        run: |-
          NPM_ROOT_LIBS=$(npm root -g)
          NPM_ROOT=$(echo $NPM_ROOT_LIBS | sed 's//lib/node_modules//')
          echo "npm-root-global-libs=$NPM_ROOT_LIBS"
          echo "path=$NPM_ROOT"
          echo path=$NPM_ROOT >> $GITHUB_OUTPUT
      - name: Cache global npm folder
        id: cache-npmg
        uses: actions/cache@v4
        with:
          path: ${{ steps.get-npm-root.outputs.path }}
          key: ${{ runner.os }}-npm-global-snyk-${{ hashFiles('.projenrc.ts') }}
      - name: Install snyk and snyk-delta
        id: install-snyk
        if: steps.cache-npmg.outputs.cache-hit != 'true'
        run: npm i -g snyk@[object Object] snyk-delta@[object Object]
      - name: Authenticate Snyk
        id: snyk-auth
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |-
          snyk auth $SNYK_TOKEN
          snyk config set org=vianho
      - name: Run snyk test
        id: sca-scan
        run: |-
          RESULT_PATH=${{ github.workspace }}/snyk_sca_result_${{ github.sha }}.json
          snyk test --prune-repeated-subdependencies --severity-threshold=high --json-file-output=$RESULT_PATH 
          echo result-path=$RESULT_PATH >> $GITHUB_OUTPUT
        continue-on-error: true
      - name: Run snyk test with delta
        id: sca-scan-with-delta
        run: cat ${{ steps.sca-scan.outputs.result-path }}  | snyk-delta --baselineOrg vianho --baselineProject a93b3425-3b4b-4218-b1b1-a67887c0591d -d
